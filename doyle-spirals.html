<!DOCTYPE html>
<title>Doyle spirals</title>
<script src="rAF.js" charset="utf-8"></script>
<script src="doyle.js" charset="utf-8"></script>
<canvas width=960 height=500></canvas>
<script>
    // Initialisation
    var canvas = document.getElementsByTagName("canvas")[0],
        context = canvas.getContext("2d");
    
    
    // Circle drawing
    function circle(x, y, r) {
        context.beginPath();
        context.arc(x, y, r, 0, 7, false);
        context.fill();
        context.lineWidth = r/10;
        context.stroke();
    }
    
    
    // Complex arithmetic
    function cmul(w, z) {
        return [
            w[0]*z[0] - w[1]*z[1],
            w[0]*z[1] + w[1]*z[0]
        ];
    }
    function modulus(p) {
        return Math.sqrt(p[0]*p[0] + p[1]*p[1]);
    }
    function crecip(z) {
        var d = z[0]*z[0] + z[1]*z[1];
        return [z[0]/d, -z[1]/d];
    }
    
    
    // Doyle spiral drawing
    var min_d = 1, max_d = canvas.width;
    function spiral(r, start_point, delta) {
        var recip_delta = crecip(delta),
            mod_delta = modulus(delta),
            mod_recip_delta = 1/mod_delta;
        
        // Spiral outwards
        for (var q = start_point, mod_q = modulus(q);
            mod_q < max_d;
            q = cmul(q, delta), mod_q *= mod_delta
        ) {
            circle(q[0], q[1], mod_q*r);
        }
        
        // Spiral inwards
        for (var q = cmul(start_point, recip_delta), mod_q = modulus(q);
            mod_q > min_d;
            q = cmul(q, recip_delta), mod_q *= mod_recip_delta
        ) {
            circle(q[0], q[1], mod_q*r);
        }
    }
    
    
    // Animation
    var p = 8, q = 23;
    var root = doyle(p, q);
    
    var frames_per_iteration = 20;
    
    function frame(i) {
        context.save();
        context.setTransform(1, 0, 0, 1, 0, 0);
        context.clearRect(0, 0, canvas.width, canvas.height);
        
        context.translate(Math.round(canvas.width/2), cy = Math.round(canvas.height/2));
        var scale = Math.pow(root.mod_a, i/frames_per_iteration);
        context.scale(scale, scale);
        context.rotate(root.arg_a * i/frames_per_iteration);
        
        var start = root.a;
        for (var i=0; i<q; i++) {
            spiral(root.r, start, root.a);
            start = cmul(start, root.b);
        }
        context.restore();
    }
    
    var frame_index = 0;
    function loop() {
        frame(frame_index);
        frame_index = (frame_index + 1) % frames_per_iteration;
        requestAnimationFrame(loop);
    }
    
    context.strokeStyle = "hsl(228, 10%, 35%)";
    context.fillStyle = "none";
    requestAnimationFrame(loop);
</script>
